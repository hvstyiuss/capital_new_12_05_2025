@extends('layouts.app')

@section('title', 'Gestion des Exploitants - Capital')

@section('content')
<div class="container mx-auto px-4 py-8">
    <!-- Header Section -->
    <div class="mb-8">
        <div class="flex items-center gap-4 mb-6">
            <div class="w-16 h-16 bg-gradient-to-br from-blue-500 to-indigo-600 rounded-2xl flex items-center justify-center">
                <i class="fas fa-user-tie text-white text-2xl"></i>
            </div>
            <div>
                <h1 class="text-4xl font-bold bg-gradient-to-r from-blue-600 to-indigo-600 bg-clip-text text-transparent">
                    Gestion des Exploitants
                </h1>
                <p class="text-gray-600 text-lg mt-2">Gérez et consultez tous les exploitants forestiers</p>
            </div>
        </div>
    </div>

    <!-- Stats Cards -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">
        <!-- Exploitants Card -->
        <div class="bg-white/80 backdrop-blur-xl rounded-2xl shadow-lg p-6 border border-white/20 hover:shadow-xl transition-all duration-300">
            <div class="flex items-center gap-4">
                <div class="w-12 h-12 bg-gradient-to-br from-blue-500 to-indigo-600 rounded-xl flex items-center justify-center">
                    <i class="fas fa-user-tie text-white text-xl"></i>
                </div>
                <div class="flex-1">
                    <h3 class="text-lg font-bold text-gray-900">Exploitants</h3>
                    <p class="text-gray-600 text-sm">{{ $exploitants->total() }} exploitants</p>
                    <span class="text-xs text-gray-500">{{ $exploitants->where('categorie', 'societe')->count() }} sociétés</span>
                </div>
            </div>
        </div>
        
        <!-- Sociétés Card -->
        <div class="bg-white/80 backdrop-blur-xl rounded-2xl shadow-lg p-6 border border-white/20 hover:shadow-xl transition-all duration-300">
            <div class="flex items-center gap-4">
                <div class="w-12 h-12 bg-gradient-to-br from-green-500 to-emerald-600 rounded-xl flex items-center justify-center">
                    <i class="fas fa-building text-white text-xl"></i>
                </div>
                <div class="flex-1">
                    <h3 class="text-lg font-bold text-gray-900">Sociétés</h3>
                    <p class="text-gray-600 text-sm">{{ $exploitants->where('categorie', 'societe')->count() }} sociétés</p>
                    <span class="text-xs text-gray-500">{{ $exploitants->where('categorie', 'societe')->where('activite', 'BI')->count() }} BI</span>
                </div>
            </div>
        </div>
        
        <!-- Personnes Physiques Card -->
        <div class="bg-white/80 backdrop-blur-xl rounded-2xl shadow-lg p-6 border border-white/20 hover:shadow-xl transition-all duration-300">
            <div class="flex items-center gap-4">
                <div class="w-12 h-12 bg-gradient-to-br from-orange-500 to-yellow-600 rounded-xl flex items-center justify-center">
                    <i class="fas fa-user text-white text-xl"></i>
                </div>
                <div class="flex-1">
                    <h3 class="text-lg font-bold text-gray-900">Personnes Physiques</h3>
                    <p class="text-gray-600 text-sm">{{ $exploitants->where('categorie', 'personne_physique')->count() }} personnes</p>
                    <span class="text-xs text-gray-500">{{ $exploitants->where('categorie', 'personne_physique')->where('activite', 'BP')->count() }} BP</span>
                </div>
            </div>
        </div>
        
        <!-- Exclusions Card -->
        <div class="bg-white/80 backdrop-blur-xl rounded-2xl shadow-lg p-6 border border-white/20 hover:shadow-xl transition-all duration-300">
            <div class="flex items-center gap-4">
                <div class="w-12 h-12 bg-gradient-to-br from-red-500 to-pink-600 rounded-xl flex items-center justify-center">
                    <i class="fas fa-exclamation-triangle text-white text-xl"></i>
                </div>
                <div class="flex-1">
                    <h3 class="text-lg font-bold text-gray-900">Exclusions</h3>
                    <p class="text-gray-600 text-sm">{{ $exploitants->where('exclusion', true)->count() }} exclus</p>
                    <span class="text-xs text-gray-500">{{ $exploitants->where('exclusion', true)->where('is_deleted', false)->count() }} actifs</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Date Filter Section -->
    <div class="mb-8">
        <div class="bg-white/80 backdrop-blur-xl rounded-3xl shadow-2xl p-8 border border-white/20">
            <div class="flex items-center gap-4 mb-6">
                <div class="w-12 h-12 bg-gradient-to-br from-purple-500 to-pink-600 rounded-xl flex items-center justify-center">
                    <i class="fas fa-calendar-alt text-white text-xl"></i>
                </div>
                <div>
                    <h2 class="text-2xl font-bold text-gray-900">Filtre par Période</h2>
                    <p class="text-gray-600">Sélectionnez une période pour filtrer les exploitants et statistiques</p>
                </div>
            </div>
            
            <form method="GET" action="{{ route('exploitants.index') }}" id="dateFilterForm" class="space-y-6">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div class="form-group">
                        <label for="start_date" class="block text-sm font-semibold text-gray-700 mb-2">
                            <i class="fas fa-calendar-plus text-purple-500 mr-2"></i>
                            Date de Début
                        </label>
                        <input type="date" 
                               class="form-input w-full px-4 py-3 border border-gray-300 rounded-xl transition-all duration-300 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-purple-500 hover:border-gray-400" 
                               id="start_date" 
                               name="start_date" 
                               value="{{ request('start_date', now()->startOfMonth()->format('Y-m-d')) }}">
                    </div>
                    
                    <div class="form-group">
                        <label for="end_date" class="block text-sm font-semibold text-gray-700 mb-2">
                            <i class="fas fa-calendar-minus text-purple-500 mr-2"></i>
                            Date de Fin
                        </label>
                        <input type="date" 
                               class="form-input w-full px-4 py-3 border border-gray-300 rounded-xl transition-all duration-300 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-purple-500 hover:border-gray-400" 
                               id="end_date" 
                               name="end_date" 
                               value="{{ request('end_date', now()->format('Y-m-d')) }}">
                    </div>
                    
                    <div class="form-group flex items-end">
                        <div class="flex gap-3 w-full">
                            <button type="submit" 
                                    class="flex-1 inline-flex items-center justify-center gap-2 px-6 py-3 bg-gradient-to-r from-purple-600 to-pink-600 text-white rounded-xl hover:from-purple-700 hover:to-pink-700 transition-all duration-300 transform hover:scale-105 shadow-lg">
                                <i class="fas fa-filter"></i>
                                <span>Filtrer</span>
                            </button>
                            <button type="button" 
                                    onclick="resetDateFilter()"
                                    class="px-4 py-3 bg-gray-100 text-gray-700 rounded-xl hover:bg-gray-200 transition-all duration-300"
                                    title="Réinitialiser">
                                <i class="fas fa-undo"></i>
                            </button>
                        </div>
                    </div>
                </div>
                
                @if(request('start_date') || request('end_date'))
                    <div class="bg-gradient-to-r from-blue-50 to-indigo-50 rounded-xl p-4 border border-blue-200">
                        <div class="flex items-center gap-2 text-blue-700">
                            <i class="fas fa-info-circle"></i>
                            <span class="font-semibold">Période sélectionnée :</span>
                            <span>{{ request('start_date') ? \Carbon\Carbon::parse(request('start_date'))->format('d/m/Y') : 'Début' }}</span>
                            <span>→</span>
                            <span>{{ request('end_date') ? \Carbon\Carbon::parse(request('end_date'))->format('d/m/Y') : 'Fin' }}</span>
                        </div>
                    </div>
                @endif
                
                <!-- Preserve other filters -->
                @if(request('search'))
                    <input type="hidden" name="search" value="{{ request('search') }}">
                @endif
                @if(request('categorie'))
                    <input type="hidden" name="categorie" value="{{ request('categorie') }}">
                @endif
                @if(request('activite'))
                    <input type="hidden" name="activite" value="{{ request('activite') }}">
                @endif
                @if(request('exclusion'))
                    <input type="hidden" name="exclusion" value="{{ request('exclusion') }}">
                @endif
                @if(request('per_page'))
                    <input type="hidden" name="per_page" value="{{ request('per_page') }}">
                @endif
            </form>
        </div>
    </div>

    <!-- Exploitants Data Table -->
    <div class="bg-white/80 backdrop-blur-xl rounded-3xl shadow-2xl p-8 border border-white/20">
        <div class="flex items-center justify-between mb-6">
            <div class="flex items-center gap-4">
                <div class="w-12 h-12 bg-gradient-to-br from-blue-500 to-indigo-600 rounded-xl flex items-center justify-center">
                    <i class="fas fa-table text-white text-xl"></i>
                </div>
                <div>
                    <h2 class="text-2xl font-bold text-gray-900">Liste des Exploitants</h2>
                    <p class="text-gray-600">Gérez et consultez tous les exploitants forestiers</p>
                </div>
            </div>
            <div class="flex gap-3">
                <button type="button" 
                        class="inline-flex items-center gap-2 px-4 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition-all duration-300"
                        onclick="refreshTable()">
                    <i class="fas fa-sync-alt"></i>
                    <span>Actualiser</span>
                </button>
                <button type="button" 
                        class="inline-flex items-center gap-2 px-4 py-2 bg-gradient-to-r from-green-600 to-emerald-600 text-white rounded-lg hover:from-green-700 hover:to-emerald-700 transition-all duration-300"
                        onclick="exportAllExploitants()">
                    <i class="fas fa-download"></i>
                    <span>Exporter Tout</span>
                </button>
                <a href="{{ route('exploitants.create') }}" 
                   class="inline-flex items-center gap-3 px-6 py-3 bg-gradient-to-r from-blue-600 to-indigo-600 text-white rounded-xl hover:from-blue-700 hover:to-indigo-700 transition-all duration-300 transform hover:scale-105 shadow-lg">
                    <i class="fas fa-plus"></i>
                    <span class="font-semibold">Nouvel Exploitant</span>
                </a>
            </div>
        </div>
        <!-- Search and Filter Section -->
        <div class="bg-gradient-to-r from-gray-50 to-slate-50 rounded-2xl p-6 border border-gray-200 mb-6">
            <div class="flex items-center gap-3 mb-4">
                <div class="w-10 h-10 bg-gradient-to-br from-gray-500 to-slate-600 rounded-xl flex items-center justify-center">
                    <i class="fas fa-search text-white"></i>
                </div>
                <h3 class="text-lg font-bold text-gray-900">Recherche et Filtres</h3>
            </div>
            <form method="GET" action="{{ route('exploitants.index') }}" id="filterForm">
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                    <div class="form-group">
                        <label for="searchInput" class="block text-sm font-semibold text-gray-700 mb-2">
                            Rechercher
                        </label>
                        <div class="relative">
                            <input type="text" 
                                   class="form-input w-full px-4 py-3 pl-12 border border-gray-300 rounded-xl transition-all duration-300 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 hover:border-gray-400" 
                                   name="search" 
                                   id="searchInput" 
                                   placeholder="Rechercher dans les exploitants..." 
                                   value="{{ request('search') }}"
                                   onkeyup="debounceFilter()">
                            <div class="absolute left-4 top-1/2 transform -translate-y-1/2 text-gray-400">
                                <i class="fas fa-search"></i>
                            </div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="categorieFilter" class="block text-sm font-semibold text-gray-700 mb-2">
                            Catégorie
                        </label>
                        <select class="form-input w-full px-4 py-3 border border-gray-300 rounded-xl transition-all duration-300 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 hover:border-gray-400" 
                                name="categorie" id="categorieFilter" onchange="submitFilter()">
                            <option value="">Toutes les catégories</option>
                            <option value="societe" {{ request('categorie') == 'societe' ? 'selected' : '' }}>Société</option>
                            <option value="personne_physique" {{ request('categorie') == 'personne_physique' ? 'selected' : '' }}>Personne Physique</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="activiteFilter" class="block text-sm font-semibold text-gray-700 mb-2">
                            Activité
                        </label>
                        <select class="form-input w-full px-4 py-3 border border-gray-300 rounded-xl transition-all duration-300 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 hover:border-gray-400" 
                                name="activite" id="activiteFilter" onchange="submitFilter()">
                            <option value="">Toutes les activités</option>
                            <option value="BI" {{ request('activite') == 'BI' ? 'selected' : '' }}>BI</option>
                            <option value="BP" {{ request('activite') == 'BP' ? 'selected' : '' }}>BP</option>
                            <option value="PAM" {{ request('activite') == 'PAM' ? 'selected' : '' }}>PAM</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="exclusionFilter" class="block text-sm font-semibold text-gray-700 mb-2">
                            Statut
                        </label>
                        <div class="flex gap-2">
                            <select class="form-input flex-1 px-4 py-3 border border-gray-300 rounded-xl transition-all duration-300 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 hover:border-gray-400" 
                                    name="exclusion" id="exclusionFilter" onchange="submitFilter()">
                                <option value="">Tous les statuts</option>
                                <option value="active" {{ request('exclusion') == 'active' ? 'selected' : '' }}>Actifs</option>
                                <option value="excluded" {{ request('exclusion') == 'excluded' ? 'selected' : '' }}>Exclus</option>
                            </select>
                            <button type="button" 
                                    class="px-4 py-3 bg-gray-100 text-gray-700 rounded-xl hover:bg-gray-200 transition-all duration-300"
                                    onclick="clearFilters()" 
                                    title="Effacer les filtres">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Hidden fields to preserve pagination -->
                @if(request('per_page'))
                    <input type="hidden" name="per_page" value="{{ request('per_page') }}">
                @endif
            </form>
        </div>

        <!-- Data Table -->
        <div class="bg-white rounded-2xl border border-gray-200 overflow-hidden">
            <div class="overflow-x-auto">
                <table class="w-full">
                    <thead class="bg-gradient-to-r from-gray-50 to-slate-50">
                        <tr>
                            <th class="px-6 py-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">ID</th>
                            <th class="px-6 py-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Numéro</th>
                            <th class="px-6 py-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Localisation</th>
                            <th class="px-6 py-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Nom/Raison Sociale</th>
                            <th class="px-6 py-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">CIN</th>
                            <th class="px-6 py-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Catégorie</th>
                            <th class="px-6 py-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Activité</th>
                            <th class="px-6 py-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Adresse</th>
                            <th class="px-6 py-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Qualification RC</th>
                            <th class="px-6 py-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Date Obtention</th>
                            <th class="px-6 py-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Durée Validité</th>
                            <th class="px-6 py-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">État Validité</th>
                            <th class="px-6 py-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Exclusion</th>
                            <th class="px-6 py-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Actions</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-200">
                        @forelse($exploitants as $exploitant)
                            <tr class="hover:bg-gray-50 transition-colors duration-200">
                                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">{{ $exploitant->id }}</td>
                                <td>
                                    @if($exploitant->numero)
                                        <span class="badge bg-secondary">{{ $exploitant->numero }}</span>
                                    @else
                                        <span class="text-muted">-</span>
                                    @endif
                                </td>
                                <td>
                                    @if($exploitant->localisation)
                                        <span class="badge bg-info">{{ $exploitant->localisation->CODE }}</span>
                                    @else
                                        <span class="text-muted">-</span>
                                    @endif
                                </td>
                                <td>
                                    @if($exploitant->categorie === 'societe')
                                        <strong>{{ $exploitant->raison_sociale ?? 'N/A' }}</strong>
                                        @if($exploitant->nom_complet)
                                            <br><small class="text-muted">{{ $exploitant->nom_complet }}</small>
                                        @endif
                                    @else
                                        <strong>{{ $exploitant->nom_complet ?? 'N/A' }}</strong>
                                        @if($exploitant->raison_sociale)
                                            <br><small class="text-muted">{{ $exploitant->raison_sociale }}</small>
                                        @endif
                                    @endif
                                </td>
                                <td>
                                    <span class="badge bg-info">{{ $exploitant->n_cin }}</span>
                                </td>
                                <td>
                                    <span class="badge {{ $exploitant->categorie === 'societe' ? 'bg-primary' : 'bg-success' }}">
                                        {{ $exploitant->categorie === 'societe' ? 'Société' : 'Personne Physique' }}
                                    </span>
                                </td>
                                <td>
                                    <span class="badge {{ $exploitant->activite === 'BI' ? 'bg-warning' : ($exploitant->activite === 'BP' ? 'bg-info' : 'bg-secondary') }}">
                                        {{ $exploitant->activite }}
                                    </span>
                                </td>
                                <td>
                                </td>
                                <td>
                                    <span title="{{ $exploitant->adresse }}">
                                        {{ Str::limit($exploitant->adresse, 30) }}
                                    </span>
                                </td>
                                <td>
                                    @if($exploitant->qualification_rc)
                                        <span class="badge bg-light text-dark">{{ $exploitant->qualification_rc }}</span>
                                    @else
                                        <span class="text-muted">-</span>
                                    @endif
                                </td>
                                <td>
                                    @if($exploitant->date_obtention)
                                        {{ $exploitant->date_obtention->format('d/m/Y') }}
                                    @else
                                        <span class="text-muted">-</span>
                                    @endif
                                </td>
                                <td>
                                    @if($exploitant->duree_validite)
                                        <span class="badge bg-light text-dark">{{ $exploitant->duree_validite }}</span>
                                    @else
                                        <span class="text-muted">-</span>
                                    @endif
                                </td>
                                <td>
                                    @if($exploitant->etat_validite)
                                        <span class="badge bg-success">{{ $exploitant->etat_validite }}</span>
                                    @else
                                        <span class="text-muted">-</span>
                                    @endif
                                </td>
                                <td>
                                    @if($exploitant->exclusion)
                                        <span class="badge bg-danger">
                                            <i class="fas fa-ban me-1"></i>Exclu
                                            @if($exploitant->duree_exclusion)
                                                <br><small>{{ $exploitant->duree_exclusion }}</small>
                                            @endif
                                        </span>
                                    @else
                                        <span class="badge bg-success">
                                            <i class="fas fa-check me-1"></i>Actif
                                        </span>
                                    @endif
                                </td>
                                <td>
                                    <div class="flex items-center gap-1">
                                        <!-- View Action -->
                                        <a href="{{ route('exploitants.show', $exploitant) }}" 
                                           class="inline-flex items-center justify-center w-8 h-8 bg-blue-100 hover:bg-blue-200 text-blue-600 rounded-lg transition-colors duration-200" 
                                           title="Voir les détails">
                                            <i class="fas fa-eye text-sm"></i>
                                        </a>
                                        
                                        <!-- Edit Action -->
                                        <a href="{{ route('exploitants.edit', $exploitant) }}" 
                                           class="inline-flex items-center justify-center w-8 h-8 bg-orange-100 hover:bg-orange-200 text-orange-600 rounded-lg transition-colors duration-200" 
                                           title="Modifier l'exploitant">
                                            <i class="fas fa-edit text-sm"></i>
                                        </a>
                                        
                                        <!-- Professional Card Action -->
                                        <a href="{{ route('exploitants.carte-professionnelle', $exploitant) }}" 
                                           target="_blank"
                                           class="inline-flex items-center justify-center w-8 h-8 bg-purple-100 hover:bg-purple-200 text-purple-600 rounded-lg transition-colors duration-200" 
                                           title="Carte Professionnelle">
                                            <i class="fas fa-id-card text-sm"></i>
                                        </a>
                                        
                                        <!-- Toggle Exclusion Action -->
                                        <button type="button" 
                                                onclick="toggleExclusion({{ $exploitant->id }}, {{ $exploitant->exclusion ? 'false' : 'true' }})"
                                                class="inline-flex items-center justify-center w-8 h-8 {{ $exploitant->exclusion ? 'bg-green-100 hover:bg-green-200 text-green-600' : 'bg-yellow-100 hover:bg-yellow-200 text-yellow-600' }} rounded-lg transition-colors duration-200" 
                                                title="{{ $exploitant->exclusion ? 'Réactiver l\'exploitant' : 'Exclure l\'exploitant' }}">
                                            @if($exploitant->exclusion)
                                                <i class="fas fa-check-circle text-sm"></i>
                                            @else
                                                <i class="fas fa-ban text-sm"></i>
                                            @endif
                                        </button>
                                        
                                        <!-- Delete Action -->
                                        <form action="{{ route('exploitants.destroy', $exploitant) }}" method="POST" class="inline">
                                            @csrf
                                            @method('DELETE')
                                            <button type="submit" 
                                                    onclick="return confirm('Êtes-vous sûr de vouloir supprimer cet exploitant ?')"
                                                    class="inline-flex items-center justify-center w-8 h-8 bg-red-100 hover:bg-red-200 text-red-600 rounded-lg transition-colors duration-200" 
                                                    title="Supprimer l'exploitant">
                                                <i class="fas fa-trash text-sm"></i>
                                            </button>
                                        </form>
                                    </div>
                                </td>
                            </tr>
                        @empty
                            <tr>
                                <td colspan="14" class="text-center py-4">
                                    <div class="text-muted">
                                        <i class="fas fa-user-tie text-4xl mb-2 d-block"></i>
                                        <p class="h5 mb-2">Aucun exploitant trouvé</p>
                                        <p class="text-muted mb-3">Commencez par créer votre premier exploitant</p>
                                        <a href="{{ route('exploitants.create') }}" class="btn btn-primary">
                                            <i class="fas fa-plus me-2"></i>Créer le Premier Exploitant
                                        </a>
                                    </div>
                                </td>
                            </tr>
                        @endforelse
                    </tbody>
                </table>
            </div>
            
        @if($exploitants->hasPages())
            <div class="bg-gray-50 px-6 py-4 border-t border-gray-200">
                <div class="flex flex-col sm:flex-row justify-between items-center gap-4">
                    <div class="text-sm text-gray-600">
                        <i class="fas fa-info-circle mr-1"></i>
                        Affichage de {{ $exploitants->firstItem() ?? 0 }} à {{ $exploitants->lastItem() ?? 0 }} 
                        sur {{ $exploitants->total() }} exploitants
                        @if(request()->hasAny(['search', 'categorie', 'activite', 'exclusion']))
                            <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-blue-100 text-blue-800 ml-2">
                                <i class="fas fa-filter mr-1"></i>Filtrés
                            </span>
                        @endif
                    </div>
                    <div class="pagination-controls">
                        {{ $exploitants->appends(request()->query())->links('pagination::bootstrap-4') }}
                    </div>
                    <div class="flex items-center gap-2">
                        <label for="perPageSelect" class="text-sm text-gray-600">Par page:</label>
                        <select class="form-input px-3 py-1 border border-gray-300 rounded-lg text-sm" 
                                id="perPageSelect" onchange="changePerPage(this.value)">
                            <option value="10" {{ request('per_page', 15) == 10 ? 'selected' : '' }}>10</option>
                            <option value="15" {{ request('per_page', 15) == 15 ? 'selected' : '' }}>15</option>
                            <option value="25" {{ request('per_page', 15) == 25 ? 'selected' : '' }}>25</option>
                            <option value="50" {{ request('per_page', 15) == 50 ? 'selected' : '' }}>50</option>
                            <option value="100" {{ request('per_page', 15) == 100 ? 'selected' : '' }}>100</option>
                        </select>
                    </div>
                </div>
            </div>
        @endif
        </div>
    </div>
</div>
                
                <!-- Quick Page Navigation -->
                @if($exploitants->hasPages() && $exploitants->lastPage() > 5)
                    <div class="row mt-3">
                        <div class="col-12">
                            <div class="quick-navigation text-center">
                                <small class="text-muted me-3">Aller à la page:</small>
                                <div class="btn-group btn-group-sm" role="group">
                                    @if($exploitants->currentPage() > 1)
                                        <a href="{{ $exploitants->appends(request()->query())->url(1) }}" class="btn btn-outline-secondary" title="Première page">
                                            <i class="fas fa-angle-double-left"></i>
                                        </a>
                                        <a href="{{ $exploitants->appends(request()->query())->previousPageUrl() }}" class="btn btn-outline-secondary" title="Page précédente">
                                            <i class="fas fa-angle-left"></i>
                                        </a>
                                    @endif
                                    
                                    @for($i = max(1, $exploitants->currentPage() - 2); $i <= min($exploitants->lastPage(), $exploitants->currentPage() + 2); $i++)
                                        <a href="{{ $exploitants->appends(request()->query())->url($i) }}" 
                                           class="btn {{ $i == $exploitants->currentPage() ? 'btn-primary' : 'btn-outline-secondary' }}">
                                            {{ $i }}
                                        </a>
                                    @endfor
                                    
                                    @if($exploitants->currentPage() < $exploitants->lastPage())
                                        <a href="{{ $exploitants->appends(request()->query())->nextPageUrl() }}" class="btn btn-outline-secondary" title="Page suivante">
                                            <i class="fas fa-angle-right"></i>
                                        </a>
                                        <a href="{{ $exploitants->appends(request()->query())->url($exploitants->lastPage()) }}" class="btn btn-outline-secondary" title="Dernière page">
                                            <i class="fas fa-angle-double-right"></i>
                                        </a>
                                    @endif
                                </div>
                            </div>
                        </div>
                    </div>
                @endif
            </div>
        </div>
    </div>

    <!-- Import/Export Section -->
    <div class="card mb-4">
        <div class="card-header">
            <h5 class="card-title mb-0">
                <i class="fas fa-download me-2"></i>Import/Export des Exploitants
            </h5>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-6">
                    <div class="d-grid">
                        <a href="{{ route('exploitants.export') }}" class="btn btn-success">
                            <i class="fas fa-download me-2"></i>Exporter les Exploitants
                        </a>
                        <small class="text-muted mt-1">Télécharger la liste des exploitants au format Excel</small>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="d-grid">
                        <a href="{{ route('excel.import.exploitants') }}" class="btn btn-info">
                            <i class="fas fa-upload me-2"></i>Importer des Exploitants
                        </a>
                        <small class="text-muted mt-1">Importer des exploitants depuis un fichier Excel</small>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@endsection

@push('scripts')
<script>
    // Reset date filter function
    function resetDateFilter() {
        // Set dates to current month
        const today = new Date();
        const firstDay = new Date(today.getFullYear(), today.getMonth(), 1);
        
        document.getElementById('start_date').value = firstDay.toISOString().split('T')[0];
        document.getElementById('end_date').value = today.toISOString().split('T')[0];
        
        // Submit the form
        document.getElementById('dateFilterForm').submit();
    }

    // Initialize table filters
    document.addEventListener('DOMContentLoaded', function() {
        initializeTableFilters();
    });

    function initializeTableFilters() {
        // Add row highlighting on hover
        const tableRows = document.querySelectorAll('tbody tr');
        tableRows.forEach(row => {
            row.addEventListener('mouseenter', function() {
                this.style.backgroundColor = '#f8f9fa';
            });
            row.addEventListener('mouseleave', function() {
                this.style.backgroundColor = '';
            });
        });
        
        // Initialize table scrolling functionality
        initializeTableScrolling();
    }

    function initializeTableScrolling() {
        const tableContainer = document.querySelector('.table-responsive');
        const scrollIndicator = document.querySelector('.table-scroll-indicator');
        
        if (tableContainer && scrollIndicator) {
            // Show scroll indicators based on scroll position
            tableContainer.addEventListener('scroll', function() {
                const { scrollTop, scrollLeft } = this;
                
                // Vertical scroll indicator
                if (scrollTop > 0) {
                    scrollIndicator.style.opacity = '1';
                } else {
                    scrollIndicator.style.opacity = '0';
                }
                
                // Horizontal scroll indicator
                if (scrollLeft > 0) {
                    scrollIndicator.style.opacity = '1';
                }
                
                // Show scroll to top button if scrolled down
                if (scrollTop > 100) {
                    showScrollToTopButton();
                } else {
                    hideScrollToTopButton();
                }
            });
            
            // Add smooth scrolling to top functionality
            addScrollToTopButton();
        }
    }

    function addScrollToTopButton() {
        // Remove existing button if any
        const existingButton = document.querySelector('.scroll-to-top-btn');
        if (existingButton) {
            existingButton.remove();
        }
        
        // Create scroll to top button
        const scrollButton = document.createElement('button');
        scrollButton.className = 'scroll-to-top-btn btn btn-primary btn-sm position-fixed';
        scrollButton.innerHTML = '<i class="fas fa-arrow-up"></i>';
        scrollButton.style.cssText = `
            bottom: 20px;
            right: 20px;
            z-index: 1000;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: none;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        `;
        
        scrollButton.addEventListener('click', function() {
            const tableContainer = document.querySelector('.table-responsive');
            if (tableContainer) {
                tableContainer.scrollTo({
                    top: 0,
                    behavior: 'smooth'
                });
            }
        });
        
        document.body.appendChild(scrollButton);
    }

    function showScrollToTopButton() {
        const scrollButton = document.querySelector('.scroll-to-top-btn');
        if (scrollButton) {
            scrollButton.style.display = 'block';
        }
    }

    function hideScrollToTopButton() {
        const scrollButton = document.querySelector('.scroll-to-top-btn');
        if (scrollButton) {
            scrollButton.style.display = 'none';
        }
    }

    // Debounced search function
    let searchTimeout;
    function debounceFilter() {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(() => {
            submitFilter();
        }, 500); // Wait 500ms after user stops typing
    }

    // Submit filter form
    function submitFilter() {
        document.getElementById('filterForm').submit();
    }

    // Clear all filters
    function clearFilters() {
        document.getElementById('searchInput').value = '';
        document.getElementById('categorieFilter').value = '';
        document.getElementById('activiteFilter').value = '';
        document.getElementById('exclusionFilter').value = '';
        submitFilter();
    }

    function updateRowCount(count) {
        const totalRows = document.querySelectorAll('tbody tr').length;
        const rowCountElement = document.getElementById('rowCount');
        if (rowCountElement) {
            rowCountElement.textContent = `${count} sur ${totalRows} exploitants`;
        }
    }

    function duplicateExploitant(exploitantId) {
        if (confirm('Voulez-vous dupliquer cet exploitant ?')) {
            // Redirect to create page with exploitant data
            window.location.href = `/settings/exploitants/create?duplicate=${exploitantId}`;
        }
    }

    function exportExploitant(exploitantId) {
        // Show loading state
        const button = event.target.closest('.dropdown-item');
        const originalText = button.innerHTML;
        button.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Export en cours...';
        
        // Make export request
        fetch(`/settings/exploitants/export?exploitant_id=${exploitantId}`, {
            method: 'GET',
            headers: {
                'X-CSRF-TOKEN': document.querySelector('meta[name="csrf-token"]').getAttribute('content')
            }
        })
        .then(response => {
            if (response.ok) {
                return response.blob();
            }
            throw new Error('Export failed');
        })
        .then(blob => {
            // Create download link
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `exploitant_${exploitantId}_${new Date().toISOString().split('T')[0]}.csv`;
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);
            
            // Reset button
            button.innerHTML = originalText;
        })
        .catch(error => {
            console.error('Export error:', error);
            alert('Erreur lors de l\'export');
            button.innerHTML = originalText;
        });
    }

    function printExploitant(exploitantId) {
        const printWindow = window.open(`/settings/exploitants/${exploitantId}?print=1`, '_blank');
        printWindow.onload = function() {
            printWindow.print();
        };
    }


    function shareExploitant(exploitantId) {
        if (navigator.share) {
            navigator.share({
                title: 'Exploitant Forestier',
                text: 'Consultez cet exploitant forestier',
                url: `${window.location.origin}/settings/exploitants/${exploitantId}`
            });
        } else {
            // Fallback: copy to clipboard
            const url = `${window.location.origin}/settings/exploitants/${exploitantId}`;
            navigator.clipboard.writeText(url).then(() => {
                alert('Lien copié dans le presse-papiers !');
            });
        }
    }

    function toggleExclusion(exploitantId, newStatus) {
        const action = newStatus ? 'exclure' : 'réactiver';
        if (confirm(`Voulez-vous ${action} cet exploitant ?`)) {
            fetch(`/settings/exploitants/${exploitantId}`, {
                method: 'PATCH',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRF-TOKEN': document.querySelector('meta[name="csrf-token"]').getAttribute('content')
                },
                body: JSON.stringify({
                    exclusion: newStatus
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    location.reload();
                } else {
                    alert('Erreur lors de la modification du statut');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Erreur lors de la modification du statut');
            });
        }
    }

    function archiveExploitant(exploitantId) {
        if (confirm('Voulez-vous archiver cet exploitant ?')) {
            fetch(`/settings/exploitants/${exploitantId}`, {
                method: 'PATCH',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRF-TOKEN': document.querySelector('meta[name="csrf-token"]').getAttribute('content')
                },
                body: JSON.stringify({
                    is_deleted: true
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    location.reload();
                } else {
                    alert('Erreur lors de l\'archivage');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Erreur lors de l\'archivage');
            });
        }
    }

    function refreshTable() {
        window.location.reload();
    }

    function exportAllExploitants() {
        // Show loading state
        const button = event.target.closest('button');
        const originalText = button.innerHTML;
        button.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Export en cours...';
        button.disabled = true;
        
        // Build export URL with current filters from URL
        let exportUrl = '/settings/exploitants/export';
        const currentUrl = new URL(window.location);
        const searchParams = currentUrl.searchParams;
        
        // Copy current filter parameters to export URL
        const filterParams = ['search', 'categorie', 'activite', 'exclusion', 'status', 'date_from', 'date_to'];
        const exportParams = new URLSearchParams();
        
        filterParams.forEach(param => {
            if (searchParams.has(param)) {
                exportParams.append(param, searchParams.get(param));
            }
        });
        
        if (exportParams.toString()) {
            exportUrl += '?' + exportParams.toString();
        }
        
        // Make export request
        fetch(exportUrl, {
            method: 'GET',
            headers: {
                'X-CSRF-TOKEN': document.querySelector('meta[name="csrf-token"]').getAttribute('content')
            }
        })
        .then(response => {
            if (response.ok) {
                return response.blob();
            }
            throw new Error('Export failed');
        })
        .then(blob => {
            // Create download link
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `exploitants_${new Date().toISOString().split('T')[0]}.csv`;
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);
            
            // Reset button
            button.innerHTML = originalText;
            button.disabled = false;
        })
        .catch(error => {
            console.error('Export error:', error);
            alert('Erreur lors de l\'export');
            button.innerHTML = originalText;
            button.disabled = false;
        });
    }

    // Per page selector functionality
    function changePerPage(perPage) {
        const url = new URL(window.location);
        url.searchParams.set('per_page', perPage);
        url.searchParams.delete('page'); // Reset to first page when changing per page
        window.location.href = url.toString();
    }

    // Add keyboard shortcuts
    document.addEventListener('keydown', function(e) {
        // Ctrl/Cmd + F to focus search
        if ((e.ctrlKey || e.metaKey) && e.key === 'f') {
            e.preventDefault();
            document.getElementById('searchInput').focus();
        }
        
        // Escape to clear search
        if (e.key === 'Escape') {
            clearFilters();
        }
        
        // Arrow keys for pagination (when not in input fields)
        if (!['INPUT', 'TEXTAREA', 'SELECT'].includes(e.target.tagName)) {
            if (e.key === 'ArrowLeft' && e.ctrlKey) {
                // Previous page
                const prevLink = document.querySelector('.pagination .page-item:not(.disabled) .page-link[rel="prev"]');
                if (prevLink) {
                    window.location.href = prevLink.href;
                }
            } else if (e.key === 'ArrowRight' && e.ctrlKey) {
                // Next page
                const nextLink = document.querySelector('.pagination .page-item:not(.disabled) .page-link[rel="next"]');
                if (nextLink) {
                    window.location.href = nextLink.href;
                }
            }
        }
    });
</script>
@endpush

@push('styles')
<style>
    /* Category Cards */
    .category-cards {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 1.5rem;
        margin-bottom: 2rem;
    }

    .category-card {
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(20px);
        border-radius: 1rem;
        padding: 1.5rem;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        transition: all 0.3s ease;
        position: relative;
        overflow: hidden;
    }

    .category-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 12px 40px rgba(0, 0, 0, 0.15);
    }

    .category-icon {
        width: 60px;
        height: 60px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-bottom: 1rem;
        font-size: 1.5rem;
        color: white;
    }

    .category-icon.design { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
    .category-icon.documents { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); }
    .category-icon.music { background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); }
    .category-icon.images { background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%); }

    .category-info h3 {
        margin: 0 0 0.5rem 0;
        font-size: 1.25rem;
        font-weight: 600;
        color: #1f2937;
    }

    .category-info p {
        margin: 0 0 0.25rem 0;
        color: #6b7280;
        font-size: 0.875rem;
    }

    .category-size {
        color: #059669;
        font-weight: 600;
        font-size: 0.875rem;
    }

    .category-options {
        position: absolute;
        top: 1rem;
        right: 1rem;
        color: #9ca3af;
        cursor: pointer;
        transition: color 0.3s ease;
    }

    .category-options:hover {
        color: #6b7280;
    }

    /* Entity Data Card */
    .entity-data-card {
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(20px);
        border-radius: 1rem;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        overflow: hidden;
    }

    .card-header {
        background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
        padding: 1.5rem;
        border-bottom: 1px solid #e2e8f0;
    }

    .card-title {
        margin: 0;
        color: #1f2937;
        font-weight: 600;
    }

    .card-body {
        padding: 1.5rem;
    }

    /* Enhanced table styling */
    .table-responsive {
        border-radius: 8px;
        overflow: auto;
        max-height: 70vh;
    }

    .table-container {
        min-width: 100%;
        overflow: auto;
    }

    /* Table overflow and scrolling enhancements */
    .table-responsive::-webkit-scrollbar {
        width: 8px;
        height: 8px;
    }

    .table-responsive::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 4px;
    }

    .table-responsive::-webkit-scrollbar-thumb {
        background: #c1c1c1;
        border-radius: 4px;
    }

    .table-responsive::-webkit-scrollbar-thumb:hover {
        background: #a8a8a8;
    }

    .table-responsive::-webkit-scrollbar-corner {
        background: #f1f1f1;
    }

    /* Ensure table headers stay visible during scroll */
    .table thead th {
        position: sticky;
        top: 0;
        z-index: 10;
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    }

    /* Horizontal scroll indicator */
    .table-scroll-indicator {
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        height: 4px;
        background: linear-gradient(90deg, transparent, #007bff, transparent);
        opacity: 0;
        transition: opacity 0.3s ease;
    }

    .table-responsive:hover .table-scroll-indicator {
        opacity: 1;
    }

    /* Enhanced table overflow handling */
    .table-responsive {
        box-shadow: inset 0 0 10px rgba(0,0,0,0.1);
    }

    .table {
        min-width: 800px; /* Ensure minimum width for readability */
    }

    /* Responsive table behavior */
    @media (max-width: 1200px) {
        .table-responsive {
            max-height: 60vh;
        }
    }

    @media (max-width: 768px) {
        .table-responsive {
            max-height: 50vh;
        }
        
        .table {
            min-width: 600px;
        }
    }

    /* Smooth scrolling behavior */
    .table-responsive {
        scroll-behavior: smooth;
    }

    /* Table row hover effects with overflow */
    .table tbody tr {
        transition: all 0.2s ease;
    }

    .table tbody tr:hover {
        transform: translateY(-1px);
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    /* Ensure actions column is always visible */
    .table td:last-child {
        position: sticky;
        right: 0;
        background: white;
        z-index: 5;
        box-shadow: -2px 0 5px rgba(0,0,0,0.1);
    }

    .table th:last-child {
        position: sticky;
        right: 0;
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        z-index: 15;
        box-shadow: -2px 0 5px rgba(0,0,0,0.1);
    }

    /* Enhanced Pagination Styling */
    .pagination-section {
        background: rgba(248, 249, 250, 0.8);
        border-radius: 8px;
        padding: 1rem;
        border: 1px solid #e9ecef;
    }

    .pagination-info {
        display: flex;
        align-items: center;
    }

    .pagination-controls .pagination {
        margin: 0;
        justify-content: center;
    }

    .pagination .page-link {
        border-radius: 6px;
        margin: 0 2px;
        border: 1px solid #dee2e6;
        color: #495057;
        transition: all 0.2s ease;
    }

    .pagination .page-link:hover {
        background-color: #e9ecef;
        border-color: #adb5bd;
        transform: translateY(-1px);
    }

    .pagination .page-item.active .page-link {
        background-color: #007bff;
        border-color: #007bff;
        box-shadow: 0 2px 4px rgba(0, 123, 255, 0.3);
    }

    .pagination .page-item.disabled .page-link {
        color: #6c757d;
        background-color: #fff;
        border-color: #dee2e6;
    }

    .quick-navigation {
        background: rgba(255, 255, 255, 0.7);
        border-radius: 6px;
        padding: 0.5rem;
        border: 1px solid #e9ecef;
    }

    .quick-navigation .btn-group .btn {
        border-radius: 4px;
        margin: 0 1px;
        transition: all 0.2s ease;
    }

    .quick-navigation .btn:hover {
        transform: translateY(-1px);
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .quick-navigation .btn-primary {
        box-shadow: 0 2px 4px rgba(0, 123, 255, 0.3);
    }

    /* Per page selector styling */
    #perPageSelect {
        min-width: 70px;
        border-radius: 6px;
        border: 1px solid #ced4da;
        transition: all 0.2s ease;
    }

    #perPageSelect:focus {
        border-color: #007bff;
        box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
    }

    /* Responsive adjustments */
    @media (max-width: 768px) {
        .pagination-section .row > div {
            margin-bottom: 1rem;
        }
        
        .pagination-info {
            justify-content: center;
            text-align: center;
        }
        
        .pagination-controls {
            order: 1;
        }
        
        .quick-navigation {
            display: none; /* Hide quick navigation on mobile */
        }
        
        .dropdown-menu {
            position: fixed !important;
            top: 50% !important;
            left: 50% !important;
            transform: translate(-50%, -50%) !important;
            width: 90vw;
            max-width: 300px;
        }
    }

    @media (max-width: 576px) {
        .pagination-section {
            padding: 0.75rem;
        }
        
        .pagination .page-link {
            padding: 0.375rem 0.5rem;
            font-size: 0.875rem;
        }
        
        .pagination-info small {
            font-size: 0.75rem;
        }
    }

    /* Sidebar backdrop overlay for mobile */
    .sidebar-backdrop {
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        background: rgba(0, 0, 0, 0.5);
        z-index: 999;
        opacity: 0;
        visibility: hidden;
        transition: all 0.3s ease;
    }

    .sidebar-backdrop.active {
        opacity: 1;
        visibility: visible;
    }
</style>
@endpush 